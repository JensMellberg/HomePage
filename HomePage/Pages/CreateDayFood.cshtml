@page
@model HomePage.Pages.CreateDayFoodModel
@{
    ViewData["Title"] = "Skapa mat";
}

<div class="page-wrapper mainscreen">
    <input type="hidden" id="datekey" value="@Model.DateQs" />
    <input type="hidden" id="datekeyFoW" value="@Model.DateQsFirstOfWeek" />
    <form class="dayfood-form" method="post" id="theForm">
        <input type="hidden" id="sideDishIds" name="sideDishIds" value="@string.Join(",", Model.DayFood.SideDishIds)" />
        <input type="hidden" name="day" value="@Model.DateKey" id="dateKeyCompact"/>
        <input type="hidden" name="delete" id="deleteHidden" value="" />
        <div class="input-wrapper">
            <input type="text" value="@Model.CurrentFilter" placeholder="filtrera..." onchange="updateTextFilter(this.value)" />
            <button type="button">Sök</button>
        </div>
        <div class="input-wrapper">
            <select name="foodId" style="max-width: 80vw" id="foodSelector">
                @foreach (var food in Model.ExistingFood) {
                    if (food.Key == Model.FoodIdFromQueryString || (Model.FoodIdFromQueryString == null && Model.DayFood?.FoodId == food.Key)) {
                        <option value="@food.Key" selected> @food.Name</option>
                    } else {
                        <option value="@food.Key"> @food.Name</option>
                    }
                }
            </select>
            <a href="CreateFood?date=@Model.DateKey">Ny maträtt</a>
        </div>
        <div class="input-wrapper">
            <a href="#" onclick="editFood()">Ändra mat</a>
        </div>
        <span>Tillbehör</span>
        <div id="existingSideDishes">
            @foreach (var sideDishId in Model.DayFood.SideDishIds) {
                <div class="input-wrapper">
                    <select style="max-width: 80vw" sideDishId="@sideDishId" class="sideDishSelect" onchange="updateSideDishHidden()">
                    </select>
                    <button type="button" class="recipe-button" onclick="deleteSideDish(this)">X</button>
                </div>
            }
        </div>
        <div class="input-wrapper">
            <select style="max-width: 80vw" sideDishId="" id="newSideDish" class="sideDishSelect" onchange="newSideDishOnChange()">
                <option value=""></option>
                @foreach (var food in Model.SideDishes)
                {
                    <option value="@food.Key"> @food.Name</option>
                }
            </select>
        </div>
        <div class="input-wrapper">
            <span>Vegetarisk</span>
            <input type="checkbox" name="isVego" checked="@Model.DayFood.IsVego" />
        </div>
        <div class="input-wrapper">
            <span>Portioner</span>
            <input type="number" step="any" name="portions" value="@Model.DayFood.PortionMultiplier.ToString().Replace(',', '.')" />
        </div>

        <div class="button-wrapper">
            <input type="submit" value="Spara mat" />
            @if (Model.CanDelete)
            {
                <button type="button" onclick="deleteFood()">Ta bort</button>
            }
            <button type="button" onclick="window.location.href = '/WeekFood?' + $('#datekeyFoW').val()">Avbryt</button>
        </div>
    </form>
</div>

<script>
    const allSelects = document.querySelectorAll('.sideDishSelect')
    Array.from(allSelects).forEach(e => {
        const selected = e.getAttribute('sideDishId')
        if (!selected) {
            return
        }

        initSideDishSelect(e, e.getAttribute('sideDishId'))
    });

    function updateSideDishHidden() {
        const allSideDishSelects = document.querySelectorAll('.sideDishSelect')
        const newValue = Array.from(allSideDishSelects).map(e => e.value).filter(e => e).join(',')
        $('#sideDishIds').val(newValue)
    }

    function newSideDishOnChange() {
        const newSideDishSelect = $('#newSideDish')
        const selectedId = newSideDishSelect.val()
        newSideDishSelect.val('')
        const newSelect = document.createElement('select')
        newSelect.classList = 'sideDishSelect'
        newSelect.onchange = () => updateSideDishHidden()
        initSideDishSelect(newSelect, selectedId)
        const wrapper = document.createElement('div')
        wrapper.classList = 'input-wrapper'
        wrapper.appendChild(newSelect)

        const deleteButton = document.createElement('button')
        deleteButton.innerText = 'X'
        deleteButton.onclick = e => deleteSideDish(e.target)
        deleteButton.classList = 'recipe-button'
        deleteButton.type = 'button'
        wrapper.appendChild(deleteButton)

        $('#existingSideDishes').append(wrapper)
        updateSideDishHidden()
    }

    function deleteSideDish(e) {
        debugger
        e.parentElement.remove()
        updateSideDishHidden()
    }

    function updateTextFilter(value) {
        const date = document.querySelectorAll('#datekey')[0].value
        window.location = '/CreateDayFood?' + date + '&filter=' + value
    }

     function deleteFood() {
        $('#deleteHidden').val('true')
        document.getElementById('theForm').submit();
    }

    function editFood() {
        const selectedFood = $('#foodSelector').val()
        const date = document.querySelectorAll('#dateKeyCompact')[0].value
        if (selectedFood) {
            window.location = '/CreateFood?date=' + date + '&foodId=' + selectedFood
        }
    }

    function initSideDishSelect(element, selectedId) {
        Array.from(document.getElementById('newSideDish').options).forEach(option => {
            if (!option.value) {
                return
            }
            const newOption = document.createElement('option')
            newOption.text = option.text
            newOption.value = option.value
            newOption.selected = option.value === selectedId
            element.appendChild(newOption)
        });
    }
</script>